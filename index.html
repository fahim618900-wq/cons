<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Notepad (Web)</title>

  <!-- CDN Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.0/docx.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --primary:#2b8aef; --muted:#7b7f87;
      --accent:#16a085;
      font-family: "Segoe UI", Roboto, "Noto Sans Bengali", sans-serif;
    }
    html,body{height:100%; margin:0; background:var(--bg); color:#111;}
    .app{max-width:980px; margin:0 auto; min-height:100vh; display:flex; flex-direction:column;}
    /* Header */
    header.top{display:flex; align-items:center; justify-content:space-between; padding:12px 16px; background:linear-gradient(90deg,#fff,#fff); box-shadow:0 1px 0 rgba(0,0,0,0.04);}
    header.top h1{margin:0; font-size:18px}
    /* Welcome screen */
    .welcome{display:flex; align-items:center; justify-content:center; height:70vh; flex-direction:column; gap:16px}
    .card{background:var(--card); padding:16px; border-radius:10px; box-shadow:0 6px 18px rgba(20,20,20,0.06); width:90%;}
    .btn{background:var(--primary); color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer;}
    .muted{color:var(--muted)}
    /* Main layout */
    .main{display:none; padding:12px; flex:1; gap:12px; flex-direction:column;}
    .searchbar{display:flex; gap:8px; align-items:center;}
    .searchbar input{flex:1; padding:10px; border-radius:10px; border:1px solid #e3e6ee; background:#fff}
    .notes-grid{display:flex; gap:12px; flex-wrap:wrap; align-content:flex-start}
    .note-card{background:var(--card); padding:12px; border-radius:10px; width:100%; box-shadow:0 6px 12px rgba(20,20,20,0.04); cursor:pointer; display:flex; justify-content:space-between; align-items:flex-start}
    @media(min-width:600px){ .note-card{width:calc(50% - 12px)} }
    @media(min-width:900px){ .note-card{width:calc(33.333% - 12px)} }
    .note-content{flex:1; margin-right:8px}
    .note-actions{display:flex; gap:6px; flex-direction:column}
    .icon-btn{width:38px;height:38px;border-radius:8px;border:none;background:#f2f4f7;display:grid;place-items:center;cursor:pointer}
    /* Floating plus icon */
    .fab{position:fixed; right:20px; bottom:20px; width:62px;height:62px;border-radius:50%; background:var(--accent); color:#fff; display:grid; place-items:center; font-size:28px; box-shadow:0 8px 20px rgba(0,0,0,0.18); border:none; cursor:pointer}
    /* Editor screen */
    .editor{display:none; padding:12px; gap:10px; flex-direction:column;}
    .editor .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .editor .canvas-wrap{position:relative; background:#fff; border-radius:8px; padding:12px; min-height:320px; box-shadow:0 6px 12px rgba(0,0,0,0.04);}
    .editor .editor-area{min-height:240px; outline:none}
    /* SVG drawing overlay */
    .svg-canvas{position:absolute; inset:12px; pointer-events:none}
    .draw-mode .svg-canvas{pointer-events:auto}
    .shape-btn.active{background:#eaf7f0}
    /* sidebar actions when viewing */
    .side-actions{display:flex; gap:8px}
    /* small helpers */
    .hidden{display:none}
    .small{font-size:13px}
    /* modal simple */
    .modal{position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,0.35); z-index:70}
    .modal .modal-card{width:96%; max-width:560px; background:#fff; border-radius:10px; padding:14px}
  </style>
</head>
<body>
  <div class="app">
    <header class="top">
      <h1>My Notepad</h1>
      <div class="muted small">Offline â€¢ LocalStorage</div>
    </header>

    <!-- WELCOME SCREEN (shown once) -->
    <div id="welcomeScreen" class="welcome">
      <div class="card" style="max-width:640px; text-align:center;">
        <h2>Welcome to My Notepad</h2>
        <p class="muted">This welcome message will not appear again.</p>
        <div style="margin-top:12px;">
          <button id="startBtn" class="btn">Open App</button>
        </div>
      </div>
    </div>

    <!-- MAIN SCREEN -->
    <div id="mainScreen" class="main">
      <div class="card" style="display:flex; flex-direction:column; gap:10px;">
        <div class="searchbar">
          <input id="searchInput" placeholder="Search notes..." />
        </div>
        <div id="notesList" class="notes-grid" style="min-height:240px; align-content:flex-start;">
          <!-- note cards will be injected here -->
        </div>
      </div>
    </div>

    <!-- VIEW / EDIT MODAL AS SCREENS -->
    <div id="viewScreen" class="modal hidden" aria-hidden="true">
      <div class="modal-card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h3 id="viewTitle">Note</h3>
          <div class="side-actions">
            <button id="shareBtn" class="icon-btn" title="Share">â¤´</button>
            <button id="deleteBtn" class="icon-btn" title="Delete">ðŸ—‘</button>
            <button id="closeViewBtn" class="icon-btn">âœ•</button>
          </div>
        </div>
        <div id="viewContent" style="margin-top:12px; background:#f8f9fb; padding:12px; border-radius:8px; min-height:140px; overflow:auto"></div>
        <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
          <button id="editFromViewBtn" class="btn">Edit</button>
        </div>
      </div>
    </div>

    <!-- EDIT / NEW NOTE SCREEN -->
    <div id="editorScreen" class="editor hidden">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div style="display:flex; gap:8px; align-items:center;">
            <input id="noteTitle" placeholder="Note title (optional)" style="padding:8px; border-radius:8px; border:1px solid #e6e9ef" />
            <div class="small muted">â€” Edit note</div>
          </div>
          <div style="display:flex; gap:8px;">
            <button id="insertTableBtn" class="icon-btn" title="Insert table">â–¦</button>
            <button id="drawToggleBtn" class="icon-btn" title="Draw shape">âœŽ</button>
            <button id="saveNoteBtn" class="btn">Save</button>
            <button id="closeEditorBtn" class="icon-btn">âœ•</button>
          </div>
        </div>

        <div class="toolbar small" style="margin-top:10px">
          <div class="muted">Tip: Type "1." or "à§§." or "Ù¡." then Enter for automatic numbering.</div>
        </div>

        <div class="canvas-wrap" id="canvasWrap" style="margin-top:12px;">
          <!-- Editable area -->
          <div id="editorArea" class="editor-area" contenteditable="true" style="min-height:220px;"></div>

          <!-- SVG overlay for drawing -->
          <svg id="svgCanvas" class="svg-canvas" xmlns="http://www.w3.org/2000/svg"></svg>
        </div>
      </div>
    </div>

    <!-- Floating plus icon (no text) -->
    <button id="fab" class="fab" title="New note">ï¼‹</button>

    <!-- SHARE OPTIONS MODAL -->
    <div id="shareModal" class="modal hidden">
      <div class="modal-card">
        <h3>Share / Export Note</h3>
        <p class="muted small">Choose a format. Layout, shapes and formatting will be preserved (PDF best preserves layout).</p>
        <div style="display:flex; gap:8px; margin-top:12px;">
          <button id="exportPdfBtn" class="btn">Export as .pdf</button>
          <button id="exportTxtBtn" class="btn" style="background:#444">Export as .txt</button>
          <button id="exportDocxBtn" class="btn" style="background:#6c5ce7">Export as .docx</button>
          <button id="exportXlsxBtn" class="btn" style="background:#e17b3b">Export as .xlsx</button>
        </div>
        <div style="margin-top:12px; display:flex; justify-content:flex-end;">
          <button id="closeShareModal" class="icon-btn">âœ•</button>
        </div>
      </div>
    </div>

  </div>

<script>
/* ============================
   Simple My Notepad Web App
   - LocalStorage based notes
   - Welcome screen shown once
   - Notes list with search
   - Floating plus icon opens editor (new note)
   - View note modal (with delete/share)
   - Editor supports:
       * Insert table (columns+rows like Word)
       * Simple SVG shape drawing (lines, rect, circle by freehand tools)
       * Auto-numbering for English, Bengali, Arabic numerals
   - Export: PDF (.pdf), TXT (.txt), DOCX (.docx), XLSX (.xlsx)
   ============================*/

/* ---------- Utilities ---------- */
const uid = () => 'n_' + Math.random().toString(36).slice(2,10);
const LS_KEY = 'my_notepad_notes_v1';
const welcomeKey = 'my_notepad_welcomed_v1';

function loadNotes(){ try{ return JSON.parse(localStorage.getItem(LS_KEY) || '[]') } catch(e){return []} }
function saveNotes(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)) }

/* ---------- Initial UI elems ---------- */
const welcomeScreen = document.getElementById('welcomeScreen');
const startBtn = document.getElementById('startBtn');
const mainScreen = document.getElementById('mainScreen');
const notesList = document.getElementById('notesList');
const searchInput = document.getElementById('searchInput');

const fab = document.getElementById('fab');
const editorScreen = document.getElementById('editorScreen');
const editorArea = document.getElementById('editorArea');
const noteTitle = document.getElementById('noteTitle');
const saveNoteBtn = document.getElementById('saveNoteBtn');
const closeEditorBtn = document.getElementById('closeEditorBtn');
const insertTableBtn = document.getElementById('insertTableBtn');
const drawToggleBtn = document.getElementById('drawToggleBtn');

const viewScreen = document.getElementById('viewScreen');
const viewContent = document.getElementById('viewContent');
const viewTitle = document.getElementById('viewTitle');
const closeViewBtn = document.getElementById('closeViewBtn');
const deleteBtn = document.getElementById('deleteBtn');
const shareBtn = document.getElementById('shareBtn');
const editFromViewBtn = document.getElementById('editFromViewBtn');

const shareModal = document.getElementById('shareModal');
const exportPdfBtn = document.getElementById('exportPdfBtn');
const exportTxtBtn = document.getElementById('exportTxtBtn');
const exportDocxBtn = document.getElementById('exportDocxBtn');
const exportXlsxBtn = document.getElementById('exportXlsxBtn');
const closeShareModal = document.getElementById('closeShareModal');

const svgCanvas = document.getElementById('svgCanvas');
const canvasWrap = document.getElementById('canvasWrap');

/* ---------- App state ---------- */
let notes = loadNotes();
let currentNoteId = null;
let drawMode = false;
let drawing = false;
let currentPath = null;

/* ---------- Welcome logic ---------- */
function showWelcomeIfNeeded(){
  const seen = localStorage.getItem(welcomeKey);
  if(seen){ welcomeScreen.style.display='none'; mainScreen.style.display='flex'; renderNotes(); }
  else{ welcomeScreen.style.display='flex'; mainScreen.style.display='none'; }
}
startBtn.addEventListener('click', ()=>{
  localStorage.setItem(welcomeKey, '1');
  welcomeScreen.style.display='none';
  mainScreen.style.display='flex';
  renderNotes();
});

/* ---------- Notes list rendering ---------- */
function renderNotes(filter=''){
  notesList.innerHTML='';
  const list = notes.filter(n=>{
    if(!filter) return true;
    const t = (n.title||'') + ' ' + (n.plainText||'');
    return t.toLowerCase().includes(filter.toLowerCase());
  });
  if(list.length===0){
    notesList.innerHTML = `<div class="muted" style="padding:30px;width:100%;text-align:center">No notes yet</div>`;
    return;
  }
  for(const note of list){
    const card = document.createElement('div');
    card.className = 'note-card';
    card.dataset.id = note.id;
    const content = document.createElement('div'); content.className='note-content';
    content.innerHTML = `<strong>${escapeHtml(note.title||'Untitled')}</strong>
      <div class="muted small" style="margin-top:6px">${escapeHtml( (note.plainText||'').slice(0,120) )}</div>`;
    const actions = document.createElement('div'); actions.className='note-actions';
    const openBtn = document.createElement('button'); openBtn.className='icon-btn'; openBtn.textContent='ðŸ”';
    openBtn.title='Open';
    openBtn.addEventListener('click', (e)=>{ e.stopPropagation(); openNote(note.id); });
    const delBtn = document.createElement('button'); delBtn.className='icon-btn'; delBtn.textContent='ðŸ—‘';
    delBtn.title='Delete'; delBtn.addEventListener('click', (e)=>{ e.stopPropagation(); deleteNote(note.id); });
    actions.appendChild(openBtn); actions.appendChild(delBtn);
    card.appendChild(content); card.appendChild(actions);
    card.addEventListener('click', ()=> openNote(note.id));
    notesList.appendChild(card);
  }
}

searchInput.addEventListener('input', ()=> renderNotes(searchInput.value));

/* ---------- Fab (new note) ---------- */
fab.addEventListener('click', ()=> openEditorForNew());

/* ---------- Editor logic ---------- */
function openEditorForNew(){
  currentNoteId = null;
  noteTitle.value = '';
  editorArea.innerHTML = '<p><br></p>';
  svgCanvas.innerHTML = '';
  editorScreen.classList.remove('hidden');
  editorScreen.style.display='flex';
  viewScreen.classList.add('hidden');
  mainScreen.style.display='none';
  editorArea.focus();
  drawMode = false; drawToggleBtn.classList.remove('active'); canvasWrap.classList.remove('draw-mode');
}
function openEditorForEdit(noteId){
  const note = notes.find(n=>n.id===noteId); if(!note) return;
  currentNoteId = note.id;
  noteTitle.value = note.title || '';
  editorArea.innerHTML = note.content || '<p><br></p>';
  try{ svgCanvas.innerHTML = note.svg || ''; }catch(e){ svgCanvas.innerHTML='';}
  editorScreen.classList.remove('hidden'); editorScreen.style.display='flex';
  mainScreen.style.display='none'; viewScreen.classList.add('hidden');
  editorArea.focus();
}

/* Save note */
saveNoteBtn.addEventListener('click', ()=>{
  const title = noteTitle.value.trim();
  const content = editorArea.innerHTML;
  const plain = editorArea.innerText || editorArea.textContent || '';
  const svg = svgCanvas.innerHTML || '';
  if(currentNoteId){
    const idx = notes.findIndex(n=>n.id===currentNoteId);
    if(idx>=0){
      notes[idx].title = title;
      notes[idx].content = content;
      notes[idx].plainText = plain;
      notes[idx].svg = svg;
    }
  } else {
    const n = { id: uid(), title, content, plainText: plain, svg };
    notes.unshift(n);
    currentNoteId = n.id;
  }
  saveNotes(notes);
  editorScreen.classList.add('hidden'); editorScreen.style.display='none';
  mainScreen.style.display='flex';
  renderNotes();
});

/* Close editor */
closeEditorBtn.addEventListener('click', ()=>{
  editorScreen.classList.add('hidden'); editorScreen.style.display='none';
  mainScreen.style.display='flex';
});

/* ---------- View note ---------- */
function openNote(noteId){
  const note = notes.find(n=>n.id===noteId);
  if(!note) return;
  currentNoteId = note.id;
  viewTitle.textContent = note.title || 'Untitled';
  // Combine content HTML + svg overlay for view
  viewContent.innerHTML = note.content || '';
  // Insert svg overlay as an inline element so shapes show
  if(note.svg){
    const wrapper = document.createElement('div'); wrapper.style.position='relative';
    wrapper.innerHTML = note.content + note.svg;
    viewContent.innerHTML = wrapper.innerHTML;
  }
  viewScreen.classList.remove('hidden'); viewScreen.style.display='grid';
  mainScreen.style.display='none';
}
closeViewBtn.addEventListener('click', ()=>{
  viewScreen.classList.add('hidden'); viewScreen.style.display='none';
  mainScreen.style.display='flex';
});
editFromViewBtn.addEventListener('click', ()=>{
  openEditorForEdit(currentNoteId);
});

/* Delete */
function deleteNote(id){
  if(!confirm('Confirm delete this note?')) return;
  notes = notes.filter(n=>n.id!==id);
  saveNotes(notes);
  renderNotes();
  viewScreen.classList.add('hidden'); mainScreen.style.display='flex';
}
deleteBtn.addEventListener('click', ()=> deleteNote(currentNoteId));

/* ---------- Insert Table (Column+Row) ---------- */
insertTableBtn.addEventListener('click', ()=>{
  const cols = prompt('Number of columns', '2'); if(!cols) return;
  const rows = prompt('Number of rows', '2'); if(!rows) return;
  const c = parseInt(cols)||2, r=parseInt(rows)||2;
  const table = document.createElement('table');
  table.style.width='100%'; table.style.borderCollapse='collapse';
  table.style.margin='6px 0';
  table.style.border='1px solid #e6e9ef';
  for(let i=0;i<r;i++){
    const tr = document.createElement('tr');
    for(let j=0;j<c;j++){
      const td = document.createElement('td');
      td.contentEditable = "true";
      td.style.border='1px solid #e6e9ef';
      td.style.padding='8px';
      td.innerHTML = '<div><br></div>';
      tr.appendChild(td);
    }
    table.appendChild(tr);
  }
  // insert at caret
  insertNodeAtCaret(table);
  editorArea.focus();
});

/* helper: insert DOM node at caret inside contenteditable */
function insertNodeAtCaret(node){
  const sel = window.getSelection();
  if(!sel || sel.rangeCount===0){ editorArea.appendChild(node); return; }
  const range = sel.getRangeAt(0);
  range.deleteContents();
  range.insertNode(node);
  // place caret after node
  range.setStartAfter(node); range.collapse(true);
  sel.removeAllRanges(); sel.addRange(range);
}

/* ---------- Simple SVG drawing (freehand) ---------- */
drawToggleBtn.addEventListener('click', ()=>{
  drawMode = !drawMode;
  if(drawMode){ drawToggleBtn.classList.add('active'); canvasWrap.classList.add('draw-mode'); svgCanvas.innerHTML = svgCanvas.innerHTML || ''; }
  else { drawToggleBtn.classList.remove('active'); canvasWrap.classList.remove('draw-mode'); }
});
svgCanvas.setAttribute('width','100%'); svgCanvas.setAttribute('height','100%');
svgCanvas.style.width='calc(100% - 24px)'; svgCanvas.style.height='calc(100% - 24px)';

/* coordinates mapping */
function getRelativePos(evt){
  const rect = svgCanvas.getBoundingClientRect();
  const x = evt.clientX - rect.left;
  const y = evt.clientY - rect.top;
  return {x, y};
}
svgCanvas.addEventListener('pointerdown', (e)=>{
  if(!drawMode) return;
  drawing = true;
  const p = getRelativePos(e);
  currentPath = document.createElementNS('http://www.w3.org/2000/svg','path');
  currentPath.setAttribute('d', `M ${p.x} ${p.y}`);
  currentPath.setAttribute('stroke','#ff4d4f');
  currentPath.setAttribute('stroke-width','2');
  currentPath.setAttribute('fill','none');
  currentPath.setAttribute('stroke-linecap','round');
  svgCanvas.appendChild(currentPath);
});
svgCanvas.addEventListener('pointermove', (e)=>{
  if(!drawing || !currentPath) return;
  const p = getRelativePos(e);
  const d = currentPath.getAttribute('d');
  currentPath.setAttribute('d', d + ` L ${p.x} ${p.y}`);
});
window.addEventListener('pointerup', ()=>{
  if(drawing){ drawing=false; currentPath=null; }
});

/* ---------- Auto-numbering logic ----------
   When Enter is pressed inside editorArea, check previous line text start for numbering patterns.
   Support: Latin digits (\d+), Bengali digits [à§¦-à§¯], Arabic-Indic digits [Ù -Ù©].
   We'll detect unicode digits and increment keeping same script.
*/
editorArea.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){
    // get caret container
    const sel = window.getSelection();
    if(!sel.rangeCount) return;
    const range = sel.getRangeAt(0).cloneRange();
    // get text node before caret on same line
    range.setStart(editorArea, 0);
    const fullBefore = range.toString();
    // extract last line before caret
    const lines = fullBefore.split(/\r?\n/);
    const lastLine = lines[lines.length-1].trim();
    const mLatin = lastLine.match(/^(\d+)\.\s*$/);
    const mBeng = lastLine.match(/^([à§¦-à§¯]+)\.\s*$/);
    const mArab = lastLine.match(/^([Ù -Ù©]+)\.\s*$/);
    if(mLatin){
      e.preventDefault();
      const num = parseInt(mLatin[1]) + 1;
      insertTextAtCaret(num + '.\u00A0'); // add non-breaking space
    } else if(mBeng){
      e.preventDefault();
      const val = bengToNumber(mBeng[1]) + 1;
      insertTextAtCaret(numberToBeng(val) + '.\u00A0');
    } else if(mArab){
      e.preventDefault();
      const val = arabToNumber(mArab[1]) + 1;
      insertTextAtCaret(numberToArab(val) + '.\u00A0');
    }
  }
});

/* helpers: insert plain text at caret */
function insertTextAtCaret(text){
  const sel = window.getSelection();
  if(!sel.rangeCount){ editorArea.appendChild(document.createTextNode(text)); return; }
  const range = sel.getRangeAt(0);
  range.deleteContents();
  const textNode = document.createTextNode(text);
  range.insertNode(textNode);
  range.setStartAfter(textNode);
  range.collapse(true);
  sel.removeAllRanges(); sel.addRange(range);
}

/* numeral conversions */
const bengDigits = 'à§¦à§§à§¨à§©à§ªà§«à§¬à§­à§®à§¯';
const arabDigits = 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©';
function bengToNumber(str){ let out=0; for(let ch of str){ out = out*10 + bengDigits.indexOf(ch); } return out; }
function numberToBeng(n){ return String(n).split('').map(d=>bengDigits[+d]).join(''); }
function arabToNumber(str){ let out=0; for(let ch of str){ out = out*10 + arabDigits.indexOf(ch); } return out; }
function numberToArab(n){ return String(n).split('').map(d=>arabDigits[+d]).join(''); }

/* ---------- Export / Share ---------- */
shareBtn.addEventListener('click', ()=> {
  shareModal.classList.remove('hidden'); shareModal.style.display='grid';
});
closeShareModal.addEventListener('click', ()=> { shareModal.classList.add('hidden'); shareModal.style.display='none'; });

/* Export as TXT */
exportTxtBtn.addEventListener('click', ()=>{
  const note = notes.find(n=>n.id===currentNoteId);
  if(!note) return alert('No note selected');
  const text = (note.plainText || note.content || '');
  const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
  saveAs(blob, ((note.title||'note') + '.txt').replace(/\s+/g,'_'));
});

/* Export as PDF (use html2canvas + jspdf) */
exportPdfBtn.addEventListener('click', async ()=>{
  const note = notes.find(n=>n.id===currentNoteId);
  if(!note) return alert('No note selected');
  // create a temporary element that combines content + svg for rendering
  const el = document.createElement('div'); el.style.width='800px'; el.style.padding='20px'; el.style.background='#fff';
  el.innerHTML = `<h2 style="font-family:inherit">${escapeHtml(note.title||'')}</h2>` + (note.content || '') + (note.svg || '');
  document.body.appendChild(el);
  try{
    const canvas = await html2canvas(el, {scale:2, useCORS:true, backgroundColor:'#ffffff'});
    const imgData = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p','pt',[canvas.width, canvas.height]);
    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
    pdf.save((note.title||'note') + '.pdf');
  } catch(err){ alert('PDF export failed: '+err); }
  document.body.removeChild(el);
});

/* Export as DOCX using docx.js (basic conversion: paragraphs and tables) */
exportDocxBtn.addEventListener('click', async ()=>{
  const note = notes.find(n=>n.id===currentNoteId);
  if(!note) return alert('No note selected');
  // very simple HTML to docx conversion: parse tables and paragraphs
  const parser = new DOMParser();
  const doc = parser.parseFromString(note.content || '','text/html');
  const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell } = window.docx;
  const docx = new Document();
  const children = [];
  Array.from(doc.body.childNodes).forEach(node=>{
    if(node.nodeName === 'TABLE'){
      const rows = Array.from(node.querySelectorAll('tr')).map(tr=>{
        const cells = Array.from(tr.querySelectorAll('td')).map(td=>{
          return new TableCell({ children: [ new Paragraph( td.textContent || '' ) ] });
        });
        return new TableRow({ children: cells });
      });
      children.push(new Table({ rows }));
    } else {
      children.push(new Paragraph(node.textContent || ''));
    }
  });
  docx.addSection({ children });
  const packer = new Packer();
  const blob = await packer.toBlob(docx);
  saveAs(blob, ((note.title||'note') + '.docx').replace(/\s+/g,'_'));
});

/* Export as XLSX using SheetJS: put content into one sheet */
exportXlsxBtn.addEventListener('click', ()=>{
  const note = notes.find(n=>n.id===currentNoteId);
  if(!note) return alert('No note selected');
  const ws = XLSX.utils.aoa_to_sheet([[note.title||'Title'], [], [ (note.plainText || '') ]]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Note');
  const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
  saveAs(new Blob([wbout], {type:'application/octet-stream'}), ((note.title||'note') + '.xlsx').replace(/\s+/g,'_'));
});

/* ---------- Helpers ---------- */
function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ---------- Simple load on start ---------- */
showWelcomeIfNeeded();

/* On load render in case welcome was seen earlier */
if(localStorage.getItem(welcomeKey)) renderNotes();

/* ---------- Open note via click handler (note card) is above; but we need global click for opening new editor from viewShareButton etc. ---------- */

/* ---------- When viewing, allow share modal actions to operate on currentNoteId ---------- */

/* ---------- Auto-save current editor content to localStorage on leaving page? (Not required) ---------- */

/* ---------- Utility: When closing modals, hide them properly ---------- */
[closeShareModal, closeViewBtn].forEach(btn=>{
  btn && btn.addEventListener('click', ()=>{
    shareModal.classList.add('hidden'); viewScreen.classList.add('hidden');
    shareModal.style.display='none'; viewScreen.style.display='none';
  });
});

/* ---------- Make sure Save note also stores svg overlay into current note when saving from editor ---------- */
/* (already included in save logic by saving svgCanvas.innerHTML) */

/* ---------- Extra: clicking outside modal closes share modal (small UX) ---------- */
shareModal.addEventListener('click', (e)=>{ if(e.target === shareModal){ shareModal.classList.add('hidden'); shareModal.style.display='none'; }});
viewScreen.addEventListener('click', (e)=>{ if(e.target === viewScreen){ viewScreen.classList.add('hidden'); viewScreen.style.display='none'; mainScreen.style.display='flex'; }});

/* ---------- When navigating back from editor, ensure main screen visible ---------- */
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) renderNotes(); });

/* ---------- Minimal: persist notes when user closes page (already saved on Save button). ---------- */

</script>
</body>
</html>
